<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Nipype - Python for Neuroimaging</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Python for Neuroimaging</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Introduction</a>
                            </li>
                            <li class="navitem">
                                <a href="../basics/" class="nav-link">Variables and primitive types</a>
                            </li>
                            <li class="navitem">
                                <a href="../math/" class="nav-link">Math operators</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Data structures <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../list/" class="dropdown-item">List</a>
</li>
                                    
<li>
    <a href="../set/" class="dropdown-item">Set</a>
</li>
                                    
<li>
    <a href="../dict/" class="dropdown-item">Dict</a>
</li>
                                    
<li>
    <a href="../tuple/" class="dropdown-item">Tuple</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../print/" class="nav-link">Print and string formatting</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Control flow <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../conditional/" class="dropdown-item">operators</a>
</li>
                                    
<li>
    <a href="../if/" class="dropdown-item">if</a>
</li>
                                    
<li>
    <a href="../for/" class="dropdown-item">for</a>
</li>
                                    
<li>
    <a href="../while/" class="dropdown-item">while</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../functions/" class="nav-link">Functions</a>
                            </li>
                            <li class="navitem">
                                <a href="../modules/" class="nav-link">Importing modules</a>
                            </li>
                            <li class="navitem">
                                <a href="../subprocess/" class="nav-link">Subprocesses</a>
                            </li>
                            <li class="navitem">
                                <a href="../cli/" class="nav-link">Writing command line tools</a>
                            </li>
                            <li class="navitem">
                                <a href="../files/" class="nav-link">Reading and writing files</a>
                            </li>
                            <li class="navitem">
                                <a href="../virtualenv/" class="nav-link">Virtual environments</a>
                            </li>
                            <li class="navitem">
                                <a href="../formats/" class="nav-link">DICOM and NIFTI</a>
                            </li>
                            <li class="navitem">
                                <a href="../learn/" class="nav-link">Machine learning primer</a>
                            </li>
                            <li class="navitem">
                                <a href="../recommendations/" class="nav-link">Recommendations</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">Nipype</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../recommendations/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#_1" class="nav-link"></a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#why-nipype" class="nav-link">Why Nipype?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#installation" class="nav-link">Installation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#1-set-up-and-activate-virtual-env" class="nav-link">1. set-up and activate virtual env</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#2-install-nipype-and-friends" class="nav-link">2. install nipype and friends</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#3-test-install" class="nav-link">3. test install</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#you-will-probably-get-warnings-but-make-sure-you-dont-have-any-errors-or-fails" class="nav-link">You will probably get warnings, but make sure you don't have any errors or fails.</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#interface-node-workflow" class="nav-link">Interface, Node, Workflow</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#now-we-can-set-the-inputs" class="nav-link">now we can set the inputs</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#getting-data-in-and-out-of-your-pipeline" class="nav-link">Getting data in and out of your pipeline</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#running-your-nipype-script-and-accessing-software-packages" class="nav-link">Running your nipype script (and accessing software packages)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#binbash" class="nav-link">!/bin/bash</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#if-running-on-slurm-could-put-all-your-sbatch-lines-here" class="nav-link">if running on SLURM, could put all your #SBATCH lines here...</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="_1"><img alt="Nipype logo" src="../assets/nipype-banner.png" /></h1>
<h2 id="why-nipype">Why Nipype?</h2>
<ol>
<li>Pulls most neuroimaging software packages into one tool. Choose and combine functions from different packages.</li>
<li>Free and open-source.</li>
<li>Caches past runs of workflow, and re-runs accordingly.</li>
<li>Easy parallelization.</li>
</ol>
<h2 id="installation">Installation</h2>
<p>Let's create a virtual environment (pop quiz!) in which to install nipype and its friends.</p>
<p>```bash</p>
<h1 id="1-set-up-and-activate-virtual-env">1. set-up and activate virtual env</h1>
<p>module load miniconda3/py39_4.11.0-ncf
python -m venv nipype39_venv
source nipype39_venv/bin/activate</p>
<h1 id="2-install-nipype-and-friends">2. install nipype and friends</h1>
<p>pip install nipype pytest sphinx networkx==3.0 nibabel==2.0.4</p>
<h1 id="3-test-install">3. test install</h1>
<p>python -c "import nipype; print(nipype.<strong>version</strong>)"
python -c "import nipype; nipype.test()"</p>
<h1 id="you-will-probably-get-warnings-but-make-sure-you-dont-have-any-errors-or-fails">You will probably get warnings, but make sure you don't have any errors or fails.</h1>
<p>```</p>
<div class="admonition note">
<p>To access the <a href="https://github.com/harvard-nrg/python-workshop/blob/main/docs/code/nipype_spm1stlevel.py"><em>full code of nipype_spm1stlevel.py (<strong>LINK</strong>)</em></a></p>
</div>
<h2 id="interface-node-workflow">Interface, Node, Workflow</h2>
<p>A nipype pipeline is composed of 3 differently "sized" objects, from smallest to largest:
1. Interfaces,
2. Nodes, and
3. Workflows</p>
<p><img alt="Figure of interfaces and nodes in a workflow" src="../assets/InterfaceNodeWorkflow.png" /></p>
<h3 id="interfaces-functions-for-fun-pipelines">Interfaces: Functions for <em>fun</em> pipelines!</h3>
<p><em>(Sorry I couldn't help myself.)</em></p>
<p><a href="https://nipype.readthedocs.io/en/latest/interfaces.html"><em>Interfaces</em></a> are Python functions that wrap the magical (mostly neuroimaging) tools from other software packages (e.g., fslmaths from FSL or recon-all from Freesurfer)</p>
<p>Like modules, interfaces aren't Python built-ins, so their modules must be imported at the beginning of your Python script (lines 1-13 of <a href="https://github.com/harvard-nrg/python-workshop/blob/main/docs/code/nipype_spm1stlevel.py"><em>nipype_spm1stlevel.py <strong>LINK</strong></em></a>):
<code>python
from nipype.interfaces import fsl, spm</code>
Then, we can call things that we imported as, for example: <code>spm.EstimateContrast()</code></p>
<h3 id="nodes-happy-package-for-an-interface">Nodes: Happy package for an interface</h3>
<p>Nodes contain the wrapped interfaces, but also:
1. inputs (including input files, or any specified paramaters), and
2. outputs.</p>
<p>Let's choose a simple example: <a href="https://nipype.readthedocs.io/en/latest/api/generated/nipype.interfaces.freesurfer.preprocess.html#mriconvert"><em>Freesurfer's mri_convert</em></a>.</p>
<p>To create a node:
```Python
from nipype.pipeline import engine as pe</p>
<p>nodeVariableName = pe.Node(package.function(), name="nameForOutputDirectory")
```</p>
<p>For example (lines 138-161 of <em>nipype_spm1stlevel.py</em>):
```python
convert = pe.Node(freesurfer.MRIConvert(), name="convert")</p>
<h1 id="now-we-can-set-the-inputs">now we can set the inputs</h1>
<p>convert.inputs.in_file = 'structural.nii.gz'
convert.inputs.out_type = 'nii'
```</p>
<h4 id="mapnode">MapNode</h4>
<p>Now in the mri_convert example above, we had a Node which took a single input (1 volume) and a single output (1 volume), but in reality, you might have a bunch of images that need to be converted, but then reconverge as a single list (of multiple volumes) when it's passed on to another node. Then you'll need a <strong>MapNode</strong>.</p>
<p><img alt="Figure of MapNode flow" src="../assets/MapNode1.png" /></p>
<p>Lines 140-142 of <em>nipype_spm1stlevel.py</em>:
<code>python
convert = pe.MapNode(freesurfer.MRIConvert(), name="convert", iterfield=['in_file'])
convert.inputs.in_file = funcFiles # more on how I made this object later
convert.inputs.out_type = 'nii'</code></p>
<h4 id="iterfield">Iterfield</h4>
<p>The <code>iterfield</code> entry is not limited to files or to MapNodes. You could use it for any input. For instance, if you're doing smoothing and want to try a bunch of different kernels, this input parameter could go in the iterfield. Or if you're doing a second level analysis over many contrasts, this could also go in the iterfield.</p>
<p><img alt="Figure of Node with an iterfield" src="../assets/Iterfield1.png" /></p>
<p>A hypothetical example:
<code>python
smooth = pe.Node(spm.Smooth(), name="smooth", iterfield=['fwhm'])
smooth.inputs.fwhm = [[2, 2, 2],[4, 4, 4]]</code></p>
<h3 id="workflow-connecting-nodes-and-passing-data">Workflow: Connecting nodes and passing data</h3>
<p>Workflows are the biggest "thing" in nipype. It links a series of nodes.</p>
<h4 id="to-create-a-workflow-lines-166-167">To create a workflow (lines 166-167):</h4>
<p><code>python
l1analysis = pe.Workflow(name='nipype_1stlevel')
l1analysis.base_dir = os.path.join(baseDir, outDir)</code></p>
<p>The important property of workflows is that it links the nodes. In the above Node and MapNode examples, we gave the node its input, but if we really want to use Nipype, one node is going to pass its <em>output</em> to another node's <em>input</em>.</p>
<h4 id="to-connect-nodes-in-a-workflow">To connect nodes in a workflow</h4>
<p>So after we make our nodes, we can connect them and tell the workflow which output should go to which input. The basic format is:</p>
<p><code>Python
workflowname.connect([(node1name, node2name, [('node1outputparameter','node2inputparameter')] )])</code></p>
<p>For example (lines 172-175):
<code>Python
l1analysis.connect([(convert, modelspec, [('out_file', 'functional_runs')]),
                    (modelspec, level1design, [('session_info', 'session_info')]),
                    (level1design, level1estimate, [('spm_mat_file', 'spm_mat_file')]),
                    (level1estimate, contrastestimate, [('spm_mat_file', 'spm_mat_file'),
                                                        ('beta_images', 'beta_images'),
                                                        ('residual_image','residual_image')])])</code></p>
<h4 id="to-run-a-workflow-lines-197-199">To run a workflow (lines 197-199):</h4>
<p>There are several options for how to run your workflow.
<code>python
l1analysis.run(plugin='MultiProc',plugin_args={'n_procs':2})
l1analysis.write_graph()</code>
You can run with other <a href="https://nipype.readthedocs.io/en/0.11.0/users/plugins.html"><em>plugins</em></a>, but FASSE seems to like this best.</p>
<h2 id="getting-data-in-and-out-of-your-pipeline">Getting data in and out of your pipeline</h2>
<p>There are many ways to get your data in and out of a nipype workflow, but my favorites are BIDSLayout and datasync.</p>
<h3 id="data-in-bidslayout">Data in: BIDSLayout</h3>
<p>BIDSLayout is from pybids (not nipype), but if your data in already in BIDS format (which it should be :), I find this to be the easiest way to grab imaging data.</p>
<p>For instance, to grab your fMRIPrep-ed functional files:
<code>Python
layout = BIDSLayout(BIDSDir, derivatives=True, validate=False)
funcFiles = layout.get(datatype='func', subject=subName,
                       task=task, session=sesName, space=space,
                       suffix='bold', extension='nii.gz',
                       return_type='filename')</code>
Anything that's specified in a <code>thing-spec</code> (e.g., <code>direction-AP</code>) format in your BIDS-compliant file name is fair game. Also, note that if you want something from your raw data directory (aka <code>bids</code> as opposed to the <code>bids/derivatives</code> directory), set <code>derivatives=False</code>.</p>
<h3 id="data-out-datasink">Data out: DataSink</h3>
<p>Nipype automatically outputs all the outputs of each node to its own directory, but it can be a bit messy, especially for MapNodes or Nodes with iterfields (e.g., <em>nipype_1stlevel/convert/mapflow/_convert0/out_file.nii</em>).</p>
<p><img alt="Directory of nipype output" src="../assets/nipype_output.png" /></p>
<p>But a <strong>DataSink</strong> Node lets you choose which files you want and their organizational structure.</p>
<p>So first, you make your DataSink Node like any other Node (line 183-184):</p>
<p>```python
datasink = pe.Node(nio.DataSink(), name="datasink")
datasink.inputs.base_directory = os.path.join(baseDir,outDir)</p>
<p>```</p>
<p>Then you connect any outputs you like to <em>datasink</em>. Notice that the <code>grumpy.@cat</code> structure; it will create a folder called <em>grumpy</em> and name the files with the <em>cat</em> prefix. If you just put a regular string, it will put the files in a directory of that name (like the SPM.mat files below)</p>
<p><code>python
l1analysis.connect([(contrastestimate, datasink,[('con_images', 'contrasts.@con'),
                                                 ('spmT_images', 'contrasts.@T')]),
                    (level1estimate, datasink,[('spm_mat_file', 'spm_mat')])])</code></p>
<p><img alt="Directory of nipype output" src="../assets/datasink_output.png" /></p>
<h4 id="another-output-workflow-graph">Another output: Workflow graph</h4>
<p>One other nice feature of Nipype is that it automatically gives you a nice figure showing the connected graph of your nodes. It will be in the main output directory, called <em>graph.png</em></p>
<p>For example:
<img alt="Pipeline graph" src="../assets/graph.png" /></p>
<h2 id="running-your-nipype-script-and-accessing-software-packages">Running your nipype script (and accessing software packages)</h2>
<p>Nipype is providing functions which Python-ize <em>access</em> to tools that may be written in another language, but not the tools themselves. You still need to <code>module load</code> (if on FASSE) or install the software packages.</p>
<p>The tricky thing is that we can't load the modules in any permanent way from <em>within</em> Python. If you're on FASSE, I suggest having a <strong>separate script</strong> that loads the necessary modules and then calls the Python script. (<a href="https://github.com/harvard-nrg/python-workshop/blob/main/docs/code/run_spm1stlevel.sh"><em>Example script: run_spm1stlevel.sh <strong>LINK</strong></em></a>)</p>
<p>```bash</p>
<h1 id="binbash">!/bin/bash</h1>
<h1 id="if-running-on-slurm-could-put-all-your-sbatch-lines-here">if running on SLURM, could put all your #SBATCH lines here...</h1>
<p>module load ncf
module load matlab/R2020b-fasrc01
module load spm/12.7487-fasrc01
module load freesurfer/6.0.0-ncf
module load fsl/6.0.4-ncf</p>
<p>python nipype_spm1stlevel.py
```</p>
<p>Then you would run this as:
<code>bash
sh run_spm1stlevel.sh</code></p>
<p>or if you're running on SLURM
<code>bash
sbatch run_spm1stlevel.sh</code></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
